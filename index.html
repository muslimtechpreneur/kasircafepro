<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir Kafe Pro</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.webmanifest">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- Chart.js for reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS (xlsx) for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- html2canvas for creating images from receipts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom styles for a more polished look */
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none; /* Prevents 'pull-to-refresh' */
        }

        /* Animation for page transitions */
        .page {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Animation for PIN/Activation input shake on error */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake {
            animation: shake 0.3s ease-in-out;
        }

        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #a0aec0; /* gray-400 */
            border-radius: 3px;
        }
        .modal-content {
            animation: zoomIn 0.3s ease-out;
        }
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">

    <!-- Activation Screen -->
    <div id="activation-screen" class="fixed inset-0 bg-gray-100 z-50 flex flex-col items-center justify-center p-4 hidden">
        <div class="text-center w-full max-w-sm">
             <svg class="mx-auto h-16 w-16 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
            </svg>
            <h1 class="text-2xl font-bold mt-4">Aktivasi Aplikasi</h1>
            <p class="text-gray-500 mt-1">Masukkan kode lisensi untuk melanjutkan.</p>
            <div class="mt-8">
                <input type="text" id="license-key-input" placeholder="Masukkan Kode Lisensi" class="w-full p-3 text-center border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                <button id="btn-activate" class="w-full mt-4 bg-indigo-500 text-white font-bold py-3 rounded-lg hover:bg-indigo-600 transition-colors">
                    Aktivasi
                </button>
            </div>
        </div>
    </div>
    
    <!-- PIN Lock Screen -->
    <div id="lock-screen" class="fixed inset-0 bg-gray-100 z-50 flex flex-col items-center justify-center p-4 hidden">
        <div class="text-center">
            <svg class="mx-auto h-16 w-16 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
            </svg>
            <h1 class="text-2xl font-bold mt-4">Masukkan PIN</h1>
            <p class="text-gray-500 mt-1">Gunakan PIN Admin atau Kasir untuk masuk.</p>
        </div>
        <div id="pin-dots" class="flex space-x-4 my-8">
            <div class="w-4 h-4 rounded-full border-2 border-gray-400"></div>
            <div class="w-4 h-4 rounded-full border-2 border-gray-400"></div>
            <div class="w-4 h-4 rounded-full border-2 border-gray-400"></div>
            <div class="w-4 h-4 rounded-full border-2 border-gray-400"></div>
        </div>
        <div class="grid grid-cols-3 gap-4 w-full max-w-xs">
            <!-- Number Pad -->
            <button class="pin-key h-16 text-2xl font-bold bg-white rounded-xl shadow-md active:scale-95 transition-transform">1</button>
            <button class="pin-key h-16 text-2xl font-bold bg-white rounded-xl shadow-md active:scale-95 transition-transform">2</button>
            <button class="pin-key h-16 text-2xl font-bold bg-white rounded-xl shadow-md active:scale-95 transition-transform">3</button>
            <button class="pin-key h-16 text-2xl font-bold bg-white rounded-xl shadow-md active:scale-95 transition-transform">4</button>
            <button class="pin-key h-16 text-2xl font-bold bg-white rounded-xl shadow-md active:scale-95 transition-transform">5</button>
            <button class="pin-key h-16 text-2xl font-bold bg-white rounded-xl shadow-md active:scale-95 transition-transform">6</button>
            <button class="pin-key h-16 text-2xl font-bold bg-white rounded-xl shadow-md active:scale-95 transition-transform">7</button>
            <button class="pin-key h-16 text-2xl font-bold bg-white rounded-xl shadow-md active:scale-95 transition-transform">8</button>
            <button class="pin-key h-16 text-2xl font-bold bg-white rounded-xl shadow-md active:scale-95 transition-transform">9</button>
            <div class="h-16"></div>
            <button class="pin-key h-16 text-2xl font-bold bg-white rounded-xl shadow-md active:scale-95 transition-transform">0</button>
            <button id="pin-backspace" class="h-16 text-2xl font-bold bg-white rounded-xl shadow-md flex items-center justify-center active:scale-95 transition-transform">
                <i class="fas fa-backspace"></i>
            </button>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="hidden">
        <main id="main-content" class="pb-24 pt-4 px-4 md:px-6">
            <!-- Page content will be injected here -->
        </main>

        <!-- Bottom Navigation Bar -->
        <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg flex justify-around">
            <button data-page="kasir" class="nav-btn flex-1 py-2 px-1 text-center text-indigo-500 flex flex-col items-center justify-center">
                <i class="fas fa-cash-register text-xl"></i>
                <span class="block text-xs font-medium">Kasir</span>
            </button>
            <button data-page="laporan" class="nav-btn flex-1 py-2 px-1 text-center text-gray-500 flex flex-col items-center justify-center">
                <i class="fas fa-chart-line text-xl"></i>
                <span class="block text-xs font-medium">Laporan</span>
            </button>
            <button data-page="produk" class="nav-btn flex-1 py-2 px-1 text-center text-gray-500 flex flex-col items-center justify-center">
                <i class="fas fa-box-open text-xl"></i>
                <span class="block text-xs font-medium">Produk</span>
            </button>
            <button data-page="pengaturan" class="nav-btn flex-1 py-2 px-1 text-center text-gray-500 flex flex-col items-center justify-center">
                <i class="fas fa-cog text-xl"></i>
                <span class="block text-xs font-medium">Pengaturan</span>
            </button>
        </nav>
    </div>

    <!-- Page Templates -->
    <template id="page-template-kasir">
        <div id="kasir-page" class="page grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Product List -->
            <div class="lg:col-span-2">
                <h1 class="text-2xl font-bold mb-4">Pilih Produk</h1>
                <div class="mb-4 relative">
                    <input type="search" id="product-search" placeholder="Cari produk berdasarkan nama atau ID..." class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <div id="category-filter-container" class="flex space-x-2 mb-4 overflow-x-auto pb-2">
                    <!-- Categories will be added here -->
                </div>
                <div id="product-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Products will be added here -->
                </div>
            </div>

            <!-- Cart -->
            <div class="bg-white p-4 rounded-xl shadow-md flex flex-col h-full">
                <h2 class="text-xl font-bold mb-4">Pesanan</h2>
                <div id="cart-items" class="flex-grow overflow-y-auto">
                    <p class="text-gray-500 text-center py-8">Keranjang kosong</p>
                </div>
                <div class="border-t border-gray-200 pt-4 mt-4">
                    <div class="flex justify-between font-semibold">
                        <span>Subtotal</span>
                        <span id="cart-subtotal">Rp 0</span>
                    </div>
                    <div id="cart-tax-line" class="flex justify-between text-sm text-gray-600">
                        <span>Pajak (11%)</span>
                        <span id="cart-tax">Rp 0</span>
                    </div>
                    <div class="flex justify-between font-bold text-lg mt-2">
                        <span>Total</span>
                        <span id="cart-total">Rp 0</span>
                    </div>
                    <button id="btn-pay" class="w-full bg-indigo-500 text-white font-bold py-3 rounded-lg mt-4 hover:bg-indigo-600 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <i class="fas fa-credit-card mr-2"></i>Bayar
                    </button>
                </div>
            </div>
        </div>
    </template>

    <template id="page-template-laporan">
        <div id="laporan-page" class="page">
            <h1 class="text-2xl font-bold mb-4">Laporan Penjualan</h1>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white p-4 rounded-xl shadow">
                    <h3 class="font-semibold text-gray-500">Pendapatan Hari Ini</h3>
                    <p id="report-today-revenue" class="text-2xl font-bold text-green-500">Rp 0</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow">
                    <h3 class="font-semibold text-gray-500">Transaksi Hari Ini</h3>
                    <p id="report-today-transactions" class="text-2xl font-bold">0</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow">
                    <h3 class="font-semibold text-gray-500">Total Pendapatan</h3>
                    <p id="report-total-revenue" class="text-2xl font-bold">Rp 0</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white p-4 rounded-xl shadow">
                    <h3 class="font-bold mb-2">Pendapatan 7 Hari Terakhir</h3>
                    <canvas id="sales-chart"></canvas>
                </div>
                <div class="bg-white p-4 rounded-xl shadow">
                    <h3 class="font-bold mb-2">Produk Terlaris</h3>
                    <canvas id="top-products-chart"></canvas>
                </div>
            </div>

            <div>
                <h2 class="text-xl font-bold mb-4">Riwayat Transaksi</h2>
                <div class="bg-white rounded-xl shadow overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-4 font-semibold text-sm">ID Transaksi</th>
                                <th class="p-4 font-semibold text-sm">Tanggal</th>
                                <th class="p-4 font-semibold text-sm">Pelanggan</th>
                                <th class="p-4 font-semibold text-sm">Total</th>
                                <th class="p-4 font-semibold text-sm">Metode</th>
                                <th class="p-4 font-semibold text-sm">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-history-table">
                            <!-- History will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </template>

    <template id="page-template-produk">
        <div id="produk-page" class="page">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold">Manajemen Produk</h1>
                <button id="btn-add-product" class="bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Tambah
                </button>
            </div>
            <div id="product-management-list" class="bg-white rounded-xl shadow overflow-hidden">
                <!-- Product management list will be populated here -->
            </div>
        </div>
    </template>

    <template id="page-template-pengaturan">
        <div id="pengaturan-page" class="page">
            <h1 class="text-2xl font-bold mb-6">Pengaturan</h1>
            <div class="space-y-6">
                <!-- Cafe Info Settings -->
                <div class="bg-white p-4 rounded-xl shadow">
                    <h3 class="font-bold text-lg mb-4">Informasi Kafe</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="cafe-name" class="block mb-1 font-medium text-sm">Nama Kafe</label>
                            <input type="text" id="cafe-name" data-setting-key="cafeName" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50 setting-input">
                        </div>
                        <div>
                            <label for="cafe-address" class="block mb-1 font-medium text-sm">Alamat Kafe</label>
                            <input type="text" id="cafe-address" data-setting-key="cafeAddress" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50 setting-input">
                        </div>
                        <div>
                            <label for="cafe-phone" class="block mb-1 font-medium text-sm">Nomor Telepon</label>
                            <input type="text" id="cafe-phone" data-setting-key="cafePhone" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50 setting-input">
                        </div>
                    </div>
                </div>

                <!-- Tax Settings -->
                <div class="bg-white p-4 rounded-xl shadow">
                    <h3 class="font-bold text-lg mb-4">Pengaturan Pajak</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <span class="font-medium text-sm">Aktifkan Pajak</span>
                            <label for="tax-enabled-toggle" class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="tax-enabled-toggle" class="sr-only peer setting-input" data-setting-key="taxEnabled">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                            </label>
                        </div>
                        <div id="tax-percent-container">
                            <label for="tax-percent" class="block mb-1 font-medium text-sm">Persentase Pajak (%)</label>
                            <input type="number" id="tax-percent" data-setting-key="taxPercent" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50 setting-input">
                        </div>
                    </div>
                </div>

                <!-- Category Management -->
                <div class="bg-white p-4 rounded-xl shadow">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-lg">Manajemen Kategori</h3>
                        <button id="btn-add-category" class="bg-indigo-500 text-white font-bold py-1 px-3 rounded-lg text-sm hover:bg-indigo-600 transition-colors">
                            <i class="fas fa-plus mr-1"></i>Tambah
                        </button>
                    </div>
                    <div id="category-list" class="space-y-2 mt-4">
                        <!-- Category list will be populated here -->
                    </div>
                </div>

                <!-- Security Settings -->
                <div class="bg-white p-4 rounded-xl shadow">
                    <h3 class="font-bold text-lg mb-2">Keamanan</h3>
                    <div class="space-y-2">
                        <button id="btn-change-admin-pin" class="w-full text-left py-3 px-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">Ubah PIN Admin</button>
                    </div>
                </div>

                <!-- Cashier Management -->
                <div class="bg-white p-4 rounded-xl shadow">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-lg">Manajemen Kasir</h3>
                        <button id="btn-add-cashier" class="bg-indigo-500 text-white font-bold py-1 px-3 rounded-lg text-sm hover:bg-indigo-600 transition-colors">
                            <i class="fas fa-plus mr-1"></i>Tambah
                        </button>
                    </div>
                    <div id="cashier-list" class="space-y-2 mt-4">
                        <!-- Cashier list will be populated here -->
                    </div>
                </div>

                <!-- Data Management -->
                <div class="bg-white p-4 rounded-xl shadow">
                    <h3 class="font-bold text-lg mb-2">Manajemen Data</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <button id="btn-export-excel" class="w-full text-left py-3 px-4 bg-green-50 rounded-lg hover:bg-green-100 transition-colors text-green-700"><i class="fas fa-file-excel mr-2"></i>Ekspor Laporan (XLSX)</button>
                        <button id="btn-backup-data" class="w-full text-left py-3 px-4 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors text-blue-700"><i class="fas fa-download mr-2"></i>Backup Data (JSON)</button>
                        <button id="btn-import-data-trigger" class="w-full text-left py-3 px-4 bg-yellow-50 rounded-lg hover:bg-yellow-100 transition-colors text-yellow-700"><i class="fas fa-upload mr-2"></i>Import Data (JSON)</button>
                        <input type="file" id="import-file-input" class="hidden" accept=".json">
                        <button id="btn-delete-data" class="w-full text-left py-3 px-4 bg-red-50 rounded-lg hover:bg-red-100 transition-colors text-red-700"><i class="fas fa-trash-alt mr-2"></i>Hapus Semua Data</button>
                    </div>
                </div>

                <!-- About -->
                <div class="bg-white p-4 rounded-xl shadow">
                    <h3 class="font-bold text-lg mb-2">Tentang</h3>
                    <div class="space-y-1">
                        <button data-modal="about-modal" class="modal-trigger w-full text-left py-2 px-2 hover:bg-gray-100 rounded-md transition-colors">Tentang Aplikasi</button>
                        <button data-modal="guide-modal" class="modal-trigger w-full text-left py-2 px-2 hover:bg-gray-100 rounded-md transition-colors">Panduan Aplikasi</button>
                        <button data-modal="privacy-modal" class="modal-trigger w-full text-left py-2 px-2 hover:bg-gray-100 rounded-md transition-colors">Kebijakan Privasi</button>
                        <a href="mailto:dukungan@example.com" class="block w-full text-left py-2 px-2 hover:bg-gray-100 rounded-md transition-colors">Kritik & Saran</a>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Modals -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center p-4">
        <!-- Add/Edit Product Modal -->
        <div id="product-modal" class="modal-content bg-white rounded-xl shadow-lg w-full max-w-md p-6 hidden">
            <h2 id="product-modal-title" class="text-2xl font-bold mb-4">Tambah Produk Baru</h2>
            <form id="product-form" novalidate>
                <input type="hidden" id="product-id">
                <input type="hidden" id="product-image-base64">
                <div class="mb-4">
                    <label for="product-name" class="block mb-1 font-medium">Nama Produk</label>
                    <input type="text" id="product-name" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50" required>
                </div>
                <div class="mb-4">
                    <label for="product-price" class="block mb-1 font-medium">Harga</label>
                    <input type="number" id="product-price" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50" required>
                </div>
                <div class="mb-4">
                    <label for="product-category" class="block mb-1 font-medium">Kategori</label>
                    <select id="product-category" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50" required>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block mb-2 font-medium">Gambar Produk</label>
                    <div class="flex space-x-4 mb-2">
                        <label class="flex items-center"><input type="radio" name="image-source" value="url" class="mr-2" checked> URL Gambar</label>
                        <label class="flex items-center"><input type="radio" name="image-source" value="upload" class="mr-2"> Unggah Gambar</label>
                    </div>
                    <div id="image-url-container">
                        <input type="text" id="product-image-url" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50" placeholder="https://example.com/image.jpg">
                    </div>
                    <div id="image-upload-container" class="hidden">
                        <input type="file" id="product-image-upload" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" accept="image/*">
                        <img id="image-preview" class="mt-2 rounded-lg max-h-32 hidden" src="" alt="Pratinjau Gambar"/>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" class="btn-close-modal px-4 py-2 bg-gray-200 rounded-lg">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">Simpan</button>
                </div>
            </form>
        </div>

        <!-- Add/Edit Category Modal -->
        <div id="category-modal" class="modal-content bg-white rounded-xl shadow-lg w-full max-w-md p-6 hidden">
            <h2 id="category-modal-title" class="text-2xl font-bold mb-4">Tambah Kategori Baru</h2>
            <form id="category-form" novalidate>
                <input type="hidden" id="category-id">
                <div class="mb-6">
                    <label for="category-name" class="block mb-1 font-medium">Nama Kategori</label>
                    <input type="text" id="category-name" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50" required>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" class="btn-close-modal px-4 py-2 bg-gray-200 rounded-lg">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">Simpan</button>
                </div>
            </form>
        </div>

        <!-- Add/Edit Cashier Modal -->
        <div id="cashier-modal" class="modal-content bg-white rounded-xl shadow-lg w-full max-w-md p-6 hidden">
            <h2 id="cashier-modal-title" class="text-2xl font-bold mb-4">Tambah Kasir Baru</h2>
            <form id="cashier-form" novalidate>
                <input type="hidden" id="cashier-id">
                <div class="mb-4">
                    <label for="cashier-name" class="block mb-1 font-medium">Nama Kasir</label>
                    <input type="text" id="cashier-name" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50" required>
                </div>
                <div class="mb-6">
                    <label for="cashier-pin" class="block mb-1 font-medium">PIN Kasir (4 Angka)</label>
                    <input type="password" id="cashier-pin" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50" required maxlength="4" pattern="\d{4}">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" class="btn-close-modal px-4 py-2 bg-gray-200 rounded-lg">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">Simpan</button>
                </div>
            </form>
        </div>

        <!-- Payment Modal -->
        <div id="payment-modal" class="modal-content bg-white rounded-xl shadow-lg w-full max-w-sm p-6 hidden">
            <h2 class="text-2xl font-bold mb-4">Pembayaran</h2>
            <div class="text-center mb-4">
                <p class="text-gray-500">Total Tagihan</p>
                <p id="payment-total" class="text-4xl font-bold">Rp 0</p>
            </div>
            <div class="mb-4">
                <label for="customer-name" class="block mb-1 font-medium">Nama Pelanggan (Opsional)</label>
                <input type="text" id="customer-name" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50">
            </div>
            <div class="mb-4">
                <label for="payment-method" class="block mb-1 font-medium">Metode Pembayaran</label>
                <select id="payment-method" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50">
                    <option value="Tunai">Tunai</option>
                    <option value="QRIS">QRIS</option>
                    <option value="Kartu Debit">Kartu Debit</option>
                    <option value="Kartu Kredit">Kartu Kredit</option>
                </select>
            </div>
            <div id="cash-payment-section" class="mb-4">
                <label for="cash-received" class="block mb-1 font-medium">Uang Diterima</label>
                <input type="number" id="cash-received" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50">
                <p class="mt-2">Kembalian: <span id="cash-change" class="font-bold">Rp 0</span></p>
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" class="btn-close-modal px-4 py-2 bg-gray-200 rounded-lg">Batal</button>
                <button id="btn-complete-payment" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Selesaikan</button>
            </div>
        </div>
        
        <!-- Receipt Modal -->
        <div id="receipt-modal" class="modal-content bg-white rounded-xl shadow-lg w-full max-w-sm p-0 hidden">
            <div id="receipt-content" class="p-6">
                <!-- Receipt will be generated here -->
            </div>
            <!-- PENAMBAHAN: Tombol baru untuk bagikan gambar -->
            <div class="p-4 bg-gray-50 flex flex-wrap justify-between gap-2 rounded-b-xl">
                 <button id="btn-print-receipt" class="flex-grow px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600"><i class="fas fa-print mr-2"></i>Cetak</button>
                 <button id="btn-share-receipt" class="flex-grow px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"><i class="fas fa-share-alt mr-2"></i>Bagikan</button>
                 <button class="btn-close-modal w-full mt-2 px-4 py-2 bg-gray-200 rounded-lg">Tutup</button>
            </div>
        </div>

        <!-- Change PIN Modal -->
        <div id="pin-modal" class="modal-content bg-white rounded-xl shadow-lg w-full max-w-sm p-6 hidden">
            <h2 id="pin-modal-title" class="text-2xl font-bold mb-4">Ubah PIN Admin</h2>
            <form id="pin-form" novalidate>
                <div class="mb-4">
                    <label for="current-admin-pin" class="block mb-1 font-medium">PIN Admin Saat Ini</label>
                    <input type="password" id="current-admin-pin" maxlength="4" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50" required>
                </div>
                <div class="mb-6">
                    <label for="new-pin" class="block mb-1 font-medium">PIN Admin Baru (4 Angka)</label>
                    <input type="password" id="new-pin" maxlength="4" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50" required pattern="\d{4}">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" class="btn-close-modal px-4 py-2 bg-gray-200 rounded-lg">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">Simpan</button>
                </div>
            </form>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirm-modal" class="modal-content bg-white rounded-xl shadow-lg w-full max-w-sm p-6 hidden text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <i id="confirm-modal-icon" class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
            </div>
            <h3 id="confirm-modal-title" class="text-lg font-medium leading-6">Judul Konfirmasi</h3>
            <div class="mt-2">
                <p id="confirm-modal-text" class="text-sm text-gray-500">Pesan konfirmasi.</p>
            </div>
            <div class="mt-5 sm:mt-6 flex justify-center space-x-3">
                <button type="button" class="btn-close-modal inline-flex justify-center rounded-md border border-gray-300 px-4 py-2 bg-white text-base font-medium hover:bg-gray-50">Batal</button>
                <button type="button" id="confirm-modal-button" class="inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700">Konfirmasi</button>
            </div>
        </div>
        
        <!-- Info Modals -->
        <div id="about-modal" class="modal-content bg-white rounded-xl shadow-lg w-full max-w-lg p-6 hidden">
            <h2 class="text-2xl font-bold mb-4">Tentang Aplikasi</h2>
            <p class="text-gray-600">Kasir Kafe Pro adalah aplikasi Point of Sale (POS) modern yang berjalan sepenuhnya di browser Anda. Dibuat dengan HTML, Tailwind CSS, dan JavaScript, aplikasi ini menggunakan IndexedDB untuk menyimpan semua data secara lokal, memungkinkan fungsionalitas offline penuh.</p>
            <p class="mt-2 text-gray-600">Versi: 2.1.0 (Share Gambar)</p>
            <div class="text-right mt-6">
                <button class="btn-close-modal px-4 py-2 bg-gray-200 rounded-lg">Tutup</button>
            </div>
        </div>
        <div id="guide-modal" class="modal-content bg-white rounded-xl shadow-lg w-full max-w-lg p-6 hidden">
            <h2 class="text-2xl font-bold mb-4">Panduan Aplikasi</h2>
            <div class="space-y-2 text-gray-600 max-h-96 overflow-y-auto pr-2">
                <p><strong>1. Login:</strong> Gunakan PIN Admin (default: 0000) atau PIN Kasir. Admin memiliki akses penuh, Kasir hanya bisa melakukan transaksi.</p>
                <p><strong>2. Pengaturan Awal:</strong> Sebagai Admin, masuk ke 'Pengaturan' untuk mengisi Info Kafe, mengatur Pajak, dan mengelola akun Kasir. Perubahan akan tersimpan otomatis.</p>
                <p><strong>3. Tambah Produk:</strong> Di halaman 'Produk', klik 'Tambah' untuk membuat menu baru. Anda bisa menggunakan URL gambar atau mengunggah file dari perangkat Anda.</p>
                <p><strong>4. Transaksi:</strong> Di halaman 'Kasir', cari produk atau pilih dari daftar. Klik 'Bayar', isi nama pelanggan (jika perlu), dan selesaikan transaksi.</p>
                <p><strong>5. Cetak/Bagikan Nota:</strong> Setelah transaksi selesai, Anda dapat 'Cetak' atau 'Bagikan' nota sebagai gambar. Fitur 'Bagikan' optimal di perangkat mobile.</p>
                <p><strong>6. Backup PENTING:</strong> Di 'Pengaturan', gunakan 'Backup Data' secara berkala untuk menyimpan data Anda sebagai file JSON. Gunakan 'Import Data' untuk memulihkannya jika perlu.</p>
            </div>
            <div class="text-right mt-6">
                <button class="btn-close-modal px-4 py-2 bg-gray-200 rounded-lg">Tutup</button>
            </div>
        </div>
        <div id="privacy-modal" class="modal-content bg-white rounded-xl shadow-lg w-full max-w-lg p-6 hidden">
            <h2 class="text-2xl font-bold mb-4">Kebijakan Privasi</h2>
            <p class="text-gray-600">Aplikasi ini menghargai privasi Anda. Semua data yang Anda masukkan (produk, transaksi, pengaturan) disimpan <strong>sepenuhnya di dalam browser Anda</strong> menggunakan teknologi IndexedDB. Tidak ada data yang dikirim atau disimpan di server eksternal mana pun. Data Anda adalah milik Anda dan hanya Anda yang dapat mengaksesnya dari perangkat dan browser yang Anda gunakan.</p>
            <p class="mt-2 text-gray-600">Karena data disimpan secara lokal, membersihkan data cache atau riwayat browser Anda dapat menghapus semua data aplikasi. Harap gunakan fitur 'Backup Data' secara teratur untuk mengamankan data Anda.</p>
            <div class="text-right mt-6">
                <button class="btn-close-modal px-4 py-2 bg-gray-200 rounded-lg">Tutup</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-x-[120%] transition-transform duration-300 z-50">
        <p id="toast-message">Operasi berhasil!</p>
    </div>
<script src="app.js"></script>
    <script>
    // --- MAIN APPLICATION SCRIPT (REFACTORED) ---
    document.addEventListener('DOMContentLoaded', () => {
        // Daftarkan service worker
        if ('serviceWorker' in navigator) {
          // We register the SW on load event to make sure the page is loaded
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('./service-worker.js') // Using ./ to be more explicit about the path
              .then(reg => console.log('SW berhasil:', reg))
              .catch(err => console.error('SW gagal:', err));
          });
        }

        const App = {
            // --- STATE & PROPERTIES ---
            db: null,
            state: {
                currentPage: 'kasir',
                currentUserRole: null, // 'admin' or 'cashier'
                currentCashierName: null,
                cart: [],
                pinInput: '',
                salesChart: null,
                topProductsChart: null,
                currentTransactionIdForModal: null, // To hold the ID for the receipt modal
            },
            
            // --- VALID LICENSE KEYS ---
            validLicenseKeys: [
                "KAFEPRO-2025-A7B3C9D", "KAFEPRO-2025-E4F8G1H", "KAFEPRO-2025-I2J6K3L",
                "KAFEPRO-2025-M7N1O5P", "KAFEPRO-2025-Q2R6S3T", "KAFEPRO-2025-U7V1W5X",
                "KAFEPRO-2025-Y2Z6A3B", "KAFEPRO-2025-C7D1E5F", "KAFEPRO-2025-G2H6I3J",
                "KAFEPRO-2025-K7L1M5N", "KAFEPRO-2025-O2P6Q3R", "KAFEPRO-2025-S7T1U5V",
                "KAFEPRO-2025-W2X6Y3Z", "KAFEPRO-2025-B7C1D5E", "KAFEPRO-2025-F2G6H3I",
                "KAFEPRO-2025-J7K1L5M", "KAFEPRO-2025-N2O6P3Q", "KAFEPRO-2025-R7S1T5U",
                "KAFEPRO-2025-V2W6X3Y", "KAFEPRO-2025-Z7A1B5C", "KAFEPRO-2025-D2E6F3G",
                "KAFEPRO-2025-H7I1J5K", "KAFEPRO-2025-L2M6N3O", "KAFEPRO-2025-P7Q1R5S",
                "KAFEPRO-2025-T2U6V3W", "KAFEPRO-2025-X7Y1Z5A", "KAFEPRO-2025-9B4C8D1",
                "KAFEPRO-2025-E5F9G2H", "KAFEPRO-2025-I3J7K4L", "KAFEPRO-2025-M8N2O6P",
                "KAFEPRO-2025-Q3R7S4T", "KAFEPRO-2025-U8V2W6X", "KAFEPRO-2025-Y3Z7A4B",
                "KAFEPRO-2025-C8D2E6F", "KAFEPRO-2025-G3H7I4J", "KAFEPRO-2025-K8L2M6N",
                "KAFEPRO-2025-O3P7Q4R", "KAFEPRO-2025-S8T2U6V", "KAFEPRO-2025-W3X7Y4Z",
                "KAFEPRO-2025-B8C2D6E", "KAFEPRO-2025-F3G7H4I", "KAFEPRO-2025-J8K2L6M",
                "KAFEPRO-2025-N3O7P4Q", "KAFEPRO-2025-R8S2T6U", "KAFEPRO-2025-V3W7X4Y",
                "KAFEPRO-2025-Z8A2B6C", "KAFEPRO-2025-D3E7F4G", "KAFEPRO-2025-H8I2J6K",
                "KAFEPRO-2025-L3M7N4O", "KAFEPRO-2025-P8Q2R6S", "KAFEPRO-2025-T3U7V4W",
                "KAFEPRO-2025-X8Y2Z6A", "KAFEPRO-BETA-001", "KAFEPRO-TRIAL-XYZ"
            ],

            // --- DOM ELEMENTS ---
            elements: {
                mainContent: document.getElementById('main-content'),
                navButtons: document.querySelectorAll('.nav-btn'),
                activationScreen: document.getElementById('activation-screen'),
                lockScreen: document.getElementById('lock-screen'),
                appContainer: document.getElementById('app-container'),
                modalContainer: document.getElementById('modal-container'),
                pinDots: document.getElementById('pin-dots'),
                toast: document.getElementById('toast'),
                toastMessage: document.getElementById('toast-message'),
            },
            
            // --- PAGE TEMPLATES ---
            templates: {
                kasir: document.getElementById('page-template-kasir').innerHTML,
                laporan: document.getElementById('page-template-laporan').innerHTML,
                produk: document.getElementById('page-template-produk').innerHTML,
                pengaturan: document.getElementById('page-template-pengaturan').innerHTML,
            },

            // --- INITIALIZATION ---
            async init() {
                this.checkActivation();
            },

            // --- ACTIVATION & LOCK SCREEN ---
            checkActivation() {
                const isActivated = localStorage.getItem('isActivated') === 'true';
                if (isActivated) {
                    this.showLockScreen();
                } else {
                    this.showActivationScreen();
                }
            },

            showActivationScreen() {
                this.elements.activationScreen.classList.remove('hidden');
                this.elements.activationScreen.classList.add('flex');
                this.elements.lockScreen.classList.add('hidden');
                this.bindActivationEvents();
            },

            showLockScreen() {
                this.elements.activationScreen.classList.add('hidden');
                this.elements.lockScreen.classList.remove('hidden');
                this.elements.lockScreen.classList.add('flex');
                this.startApp();
            },

            async startApp() {
                 try {
                    await this.initDB();
                    await this.initDefaultData();
                    this.bindEvents();
                    console.log("Aplikasi berhasil diinisialisasi.");
                } catch (error) {
                    console.error('Inisialisasi gagal:', error);
                    document.body.innerHTML = `<div class="p-4 text-center text-red-500 bg-red-100 rounded-lg m-4">Gagal memuat aplikasi. Pastikan browser Anda mendukung IndexedDB dan tidak dalam mode private yang ketat.</div>`;
                }
            },

            bindActivationEvents() {
                document.getElementById('btn-activate').addEventListener('click', () => this.handleActivation());
                document.getElementById('license-key-input').addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') this.handleActivation();
                });
            },

            handleActivation() {
                const input = document.getElementById('license-key-input');
                const key = input.value.trim().toUpperCase();
                
                if (this.validLicenseKeys.includes(key)) {
                    localStorage.setItem('isActivated', 'true');
                    this.showToast('Aktivasi berhasil!');
                    this.showLockScreen();
                } else {
                    this.showToast('Kode lisensi tidak valid.', true);
                    input.classList.add('shake');
                    setTimeout(() => input.classList.remove('shake'), 500);
                }
            },

            // --- DATABASE ---
            initDB() {
                return new Promise((resolve, reject) => {
                    const DB_NAME = 'KasirKafeProDB';
                    const DB_VERSION = 2;
                    const request = indexedDB.open(DB_NAME, DB_VERSION);

                    request.onerror = (event) => {
                        console.error('Database error:', event.target.errorCode);
                        reject('Database error');
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('products')) {
                            db.createObjectStore('products', { keyPath: 'id', autoIncrement: true });
                        }
                        if (!db.objectStoreNames.contains('categories')) {
                            const categoryStore = db.createObjectStore('categories', { keyPath: 'id', autoIncrement: true });
                            categoryStore.createIndex('name', 'name', { unique: true });
                        }
                        if (!db.objectStoreNames.contains('transactions')) {
                            db.createObjectStore('transactions', { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings', { keyPath: 'key' });
                        }
                        if (!db.objectStoreNames.contains('cashiers')) {
                            db.createObjectStore('cashiers', { keyPath: 'id', autoIncrement: true });
                        }
                    };

                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        console.log('Database initialized successfully');
                        resolve();
                    };
                });
            },

            async initDefaultData() {
                const defaultSettings = { 
                    adminPin: '0000', 
                    cafeName: 'Nama Kafe Anda', 
                    cafeAddress: 'Alamat Kafe Anda', 
                    cafePhone: 'No. Telepon Anda',
                    taxEnabled: true,
                    taxPercent: 11
                };
                for (const key in defaultSettings) {
                    if (await this.getSetting(key) === null) {
                        await this.saveSetting(key, defaultSettings[key]);
                    }
                }
                const categories = await this.getFromDB('categories');
                if (categories.length === 0) {
                    await this.saveToDB('categories', { name: 'Makanan' });
                    await this.saveToDB('categories', { name: 'Minuman' });
                }
            },

            // --- EVENT BINDING ---
            bindEvents() {
                document.addEventListener('click', this.handleClicks.bind(this));
                document.addEventListener('submit', this.handleSubmits.bind(this));
                document.addEventListener('change', this.handleChanges.bind(this));
                document.addEventListener('input', this.handleInputs.bind(this));
            },

            handleClicks(e) {
                const target = e.target;
                // PIN Pad
                if (target.matches('.pin-key')) this.handlePinKey(target.textContent);
                if (target.closest('#pin-backspace')) this.handlePinKey('backspace');
                // Navigation
                if (target.closest('.nav-btn')) this.navigateTo(target.closest('.nav-btn').dataset.page);
                // Modals
                if (target.closest('.modal-trigger')) this.openModal(target.closest('.modal-trigger').dataset.modal);
                if (target.closest('.btn-close-modal') || target.id === 'modal-container') this.closeModal();
                // Specific Buttons
                if (target.closest('#btn-add-product')) this.openProductModal();
                if (target.closest('#btn-add-category')) this.openCategoryModal();
                if (target.closest('#btn-add-cashier')) this.openCashierModal();
                if (target.closest('#btn-change-admin-pin')) this.openPinModal();
                if (target.closest('#btn-pay')) this.openPaymentModal();
                if (target.closest('#btn-complete-payment')) this.completePayment();
                if (target.closest('#btn-print-receipt')) this.printReceipt();
                if (target.closest('#btn-share-receipt')) this.shareReceiptAsImage(); // New event for sharing
                // Data Management
                if (target.closest('#btn-export-excel')) this.exportToExcel();
                if (target.closest('#btn-backup-data')) this.backupData();
                if (target.closest('#btn-import-data-trigger')) document.getElementById('import-file-input').click();
                if (target.closest('#btn-delete-data')) this.openConfirmModal('Hapus Semua Data?', 'Tindakan ini akan menghapus semua produk, kategori, dan riwayat transaksi secara permanen. Lanjutkan?', this.deleteAllData.bind(this));
                // Kasir Page
                if (target.closest('.product-card')) this.addProductToCart(parseInt(target.closest('.product-card').dataset.id));
                if (target.closest('.category-filter-btn')) this.filterByCategory(target.closest('.category-filter-btn'));
                if (target.closest('.cart-item .btn-inc')) this.updateCartItemQuantity(parseInt(target.closest('.cart-item').dataset.id), 1);
                if (target.closest('.cart-item .btn-dec')) this.updateCartItemQuantity(parseInt(target.closest('.cart-item').dataset.id), -1);
                if (target.closest('.cart-item .btn-remove')) this.removeCartItem(parseInt(target.closest('.cart-item').dataset.id));
                // Laporan Page
                if (target.closest('.view-receipt-btn')) this.showReceipt(target.closest('.view-receipt-btn').dataset.id);
                // Produk Page
                if (target.closest('.btn-edit-product')) this.editProduct(parseInt(target.closest('.product-manage-item').dataset.id));
                if (target.closest('.btn-delete-product')) {
                    const id = parseInt(target.closest('.product-manage-item').dataset.id);
                    this.openConfirmModal('Hapus Produk?', 'Tindakan ini tidak dapat dibatalkan.', () => this.deleteProduct(id));
                }
                // Pengaturan Page
                if (target.closest('.btn-edit-category')) this.editCategory(parseInt(target.closest('.category-item').dataset.id));
                if (target.closest('.btn-delete-category')) {
                    const id = parseInt(target.closest('.category-item').dataset.id);
                    this.openConfirmModal('Hapus Kategori?', 'Tindakan ini tidak dapat dibatalkan.', () => this.deleteCategory(id));
                }
                if (target.closest('.btn-edit-cashier')) this.editCashier(parseInt(target.closest('.cashier-item').dataset.id));
                if (target.closest('.btn-delete-cashier')) {
                    const id = parseInt(target.closest('.cashier-item').dataset.id);
                    this.openConfirmModal('Hapus Kasir?', 'Tindakan ini tidak dapat dibatalkan.', () => this.deleteCashier(id));
                }
            },

            handleSubmits(e) {
                e.preventDefault();
                const formId = e.target.id;
                if (formId === 'product-form') this.saveProductForm();
                if (formId === 'category-form') this.saveCategoryForm();
                if (formId === 'cashier-form') this.saveCashierForm();
                if (formId === 'pin-form') this.savePinForm();
            },
            
            handleChanges(e) {
                if (e.target.matches('.setting-input')) {
                    const key = e.target.dataset.settingKey;
                    const value = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
                    this.saveSetting(key, value);
                    this.showToast('Pengaturan disimpan.');
                    if (key === 'taxEnabled') {
                        document.getElementById('tax-percent-container').style.display = value ? 'block' : 'none';
                    }
                }
                if (e.target.id === 'product-image-upload') {
                    this.handleImageUpload(e.target.files[0]);
                }
                if (e.target.name === 'image-source') {
                    const isUrl = e.target.value === 'url';
                    document.getElementById('image-url-container').classList.toggle('hidden', !isUrl);
                    document.getElementById('image-upload-container').classList.toggle('hidden', isUrl);
                }
                if (e.target.id === 'payment-method') {
                    document.getElementById('cash-payment-section').style.display = e.target.value === 'Tunai' ? 'block' : 'none';
                }
                 if (e.target.id === 'import-file-input') {
                    this.importData(e);
                }
            },

            handleInputs(e) {
                if (e.target.id === 'product-search') {
                    const activeCategoryBtn = document.querySelector('.category-filter-btn.bg-indigo-500');
                    const category = activeCategoryBtn ? activeCategoryBtn.dataset.category : 'all';
                    this.renderProducts(category, e.target.value);
                }
                if (e.target.id === 'cash-received') {
                    this.calculateChange();
                }
            },

            // --- ROUTING & PAGE INIT ---
            navigateTo(pageName) {
                if (!this.templates[pageName]) return;
                if (this.state.currentUserRole === 'cashier' && pageName !== 'kasir') {
                    this.showToast('Akses ditolak. Hanya untuk Admin.', true);
                    return;
                }
                this.state.currentPage = pageName;
                this.elements.mainContent.innerHTML = this.templates[pageName];

                this.elements.navButtons.forEach(btn => {
                    const isActive = btn.dataset.page === pageName;
                    btn.classList.toggle('text-indigo-500', isActive);
                    btn.classList.toggle('text-gray-500', !isActive);
                });
                
                this.initPage(pageName);
            },

            async initPage(pageName) {
                switch(pageName) {
                    case 'kasir': await this.initKasirPage(); break;
                    case 'laporan': await this.initLaporanPage(); break;
                    case 'produk': await this.initProdukPage(); break;
                    case 'pengaturan': await this.initPengaturanPage(); break;
                }
            },

            // --- KASIR PAGE ---
            async initKasirPage() {
                await this.renderProducts();
                await this.renderCategoryFilters();
                await this.updateCartView();
            },
            
            async renderProducts(category = 'all', searchQuery = '') {
                const productListEl = document.getElementById('product-list');
                if (!productListEl) return;
                let products = await this.getFromDB('products');
                
                if (category !== 'all') {
                    products = products.filter(p => p.category.toLowerCase() === category.toLowerCase());
                }

                if (searchQuery) {
                    const lowerCaseQuery = searchQuery.toLowerCase();
                    products = products.filter(p => 
                        p.name.toLowerCase().includes(lowerCaseQuery) ||
                        this.formatProductId(p.id).toLowerCase().includes(lowerCaseQuery)
                    );
                }

                productListEl.innerHTML = '';
                if (products.length === 0) {
                    productListEl.innerHTML = `<p class="col-span-full text-center text-gray-500 py-8">Produk tidak ditemukan.</p>`;
                    return;
                }

                products.forEach(product => {
                    const placeholderImg = `https://placehold.co/300x300/e2e8f0/4a5568?text=${encodeURIComponent(product.name.charAt(0))}`;
                    const productCard = `
                        <div class="product-card cursor-pointer bg-white rounded-xl shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300" data-id="${product.id}">
                            <img src="${product.image || placeholderImg}" onerror="this.onerror=null;this.src='${placeholderImg}';" alt="${product.name}" class="w-full h-32 object-cover">
                            <div class="p-3">
                                <h3 class="font-semibold truncate">${product.name}</h3>
                                <div class="flex justify-between items-center mt-1">
                                    <p class="text-indigo-500 font-bold">${this.formatCurrency(product.price)}</p>
                                    <p class="text-xs text-gray-400">${this.formatProductId(product.id)}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    productListEl.innerHTML += productCard;
                });
            },

            async renderCategoryFilters() {
                const categories = await this.getFromDB('categories');
                const container = document.getElementById('category-filter-container');
                if (!container) return;
                
                const allButton = `<button class="category-filter-btn bg-indigo-500 text-white px-4 py-2 rounded-full text-sm font-semibold whitespace-nowrap" data-category="all">Semua</button>`;
                const categoryButtons = categories.map(cat => 
                    `<button class="category-filter-btn bg-white text-gray-700 px-4 py-2 rounded-full text-sm font-semibold whitespace-nowrap" data-category="${cat.name.toLowerCase()}">${cat.name}</button>`
                ).join('');

                container.innerHTML = allButton + categoryButtons;
            },

            filterByCategory(btn) {
                document.querySelectorAll('.category-filter-btn').forEach(b => {
                    b.classList.remove('bg-indigo-500', 'text-white');
                    b.classList.add('bg-white', 'text-gray-700');
                });
                btn.classList.add('bg-indigo-500', 'text-white');
                btn.classList.remove('bg-white', 'text-gray-700');
                this.renderProducts(btn.dataset.category, document.getElementById('product-search').value);
            },

            async addProductToCart(productId) {
                const existingItem = this.state.cart.find(item => item.id === productId);
                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    const product = await this.getFromDBById('products', productId);
                    if (product) this.state.cart.push({ ...product, quantity: 1 });
                }
                this.updateCartView();
            },
            
            updateCartItemQuantity(productId, change) {
                const item = this.state.cart.find(i => i.id === productId);
                if (item) {
                    item.quantity += change;
                    if (item.quantity <= 0) this.removeCartItem(productId);
                    else this.updateCartView();
                }
            },
            
            removeCartItem(productId) {
                this.state.cart = this.state.cart.filter(item => item.id !== productId);
                this.updateCartView();
            },

            async updateCartView() {
                const cartItemsEl = document.getElementById('cart-items');
                if (!cartItemsEl) return;
                
                const subtotalEl = document.getElementById('cart-subtotal');
                const taxLineEl = document.getElementById('cart-tax-line');
                const taxLabelEl = taxLineEl.querySelector('span:first-child');
                const taxEl = document.getElementById('cart-tax');
                const totalEl = document.getElementById('cart-total');
                const payBtn = document.getElementById('btn-pay');

                const taxEnabled = await this.getSetting('taxEnabled');
                const taxPercent = await this.getSetting('taxPercent') || 0;
                const taxRate = taxEnabled ? parseFloat(taxPercent) / 100 : 0;

                if (this.state.cart.length === 0) {
                    cartItemsEl.innerHTML = `<p class="text-gray-500 text-center py-8">Keranjang kosong</p>`;
                    subtotalEl.textContent = this.formatCurrency(0);
                    taxEl.textContent = this.formatCurrency(0);
                    totalEl.textContent = this.formatCurrency(0);
                    payBtn.disabled = true;
                    taxLineEl.style.display = 'none';
                    return;
                }

                cartItemsEl.innerHTML = '';
                let subtotal = 0;
                this.state.cart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    subtotal += itemTotal;
                    cartItemsEl.innerHTML += `
                        <div class="cart-item flex items-center justify-between py-2" data-id="${item.id}">
                            <div class="flex-grow pr-2">
                                <p class="font-semibold truncate">${item.name}</p>
                                <p class="text-sm text-gray-500">${this.formatCurrency(item.price)}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="btn-dec w-6 h-6 rounded-full bg-gray-200 hover:bg-gray-300 transition">-</button>
                                <span>${item.quantity}</span>
                                <button class="btn-inc w-6 h-6 rounded-full bg-gray-200 hover:bg-gray-300 transition">+</button>
                            </div>
                            <p class="font-bold w-20 text-right">${this.formatCurrency(itemTotal)}</p>
                            <button class="btn-remove ml-2 text-red-500 hover:text-red-700 w-6 h-6 flex items-center justify-center"><i class="fas fa-times-circle"></i></button>
                        </div>
                    `;
                });
                
                const tax = subtotal * taxRate;
                const total = subtotal + tax;

                if (taxEnabled && tax > 0) {
                    taxLineEl.style.display = 'flex';
                    taxLabelEl.textContent = `Pajak (${taxPercent}%)`;
                    taxEl.textContent = this.formatCurrency(tax);
                } else {
                    taxLineEl.style.display = 'none';
                }
                
                subtotalEl.textContent = this.formatCurrency(subtotal);
                totalEl.textContent = this.formatCurrency(total);
                payBtn.disabled = false;
            },

            // --- LAPORAN PAGE ---
            async initLaporanPage() {
                const transactions = await this.getFromDB('transactions');
                this.renderReportSummary(transactions);
                this.renderSalesChart(transactions);
                this.renderTopProductsChart(transactions);
                this.renderTransactionHistory(transactions.sort((a,b) => b.date - a.date));
            },
            
            renderReportSummary(transactions) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayTransactions = transactions.filter(t => new Date(t.date) >= today);
                const todayRevenue = todayTransactions.reduce((sum, t) => sum + t.total, 0);
                const totalRevenue = transactions.reduce((sum, t) => sum + t.total, 0);
                document.getElementById('report-today-revenue').textContent = this.formatCurrency(todayRevenue);
                document.getElementById('report-today-transactions').textContent = todayTransactions.length;
                document.getElementById('report-total-revenue').textContent = this.formatCurrency(totalRevenue);
            },

            renderSalesChart(transactions) {
                const ctx = document.getElementById('sales-chart')?.getContext('2d');
                if (!ctx) return;
                const labels = [];
                const data = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    d.setHours(0,0,0,0);
                    labels.push(d.toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric'}));
                    const salesOnDay = transactions
                        .filter(t => new Date(t.date).setHours(0,0,0,0) === d.getTime())
                        .reduce((sum, t) => sum + t.total, 0);
                    data.push(salesOnDay);
                }
                if (this.state.salesChart) this.state.salesChart.destroy();
                this.state.salesChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Pendapatan', data, backgroundColor: 'rgba(79, 70, 229, 0.7)', borderColor: 'rgb(79, 70, 229)', borderWidth: 1, borderRadius: 5 }] }, options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { callback: (value) => this.formatCurrency(value) } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (context) => this.formatCurrency(context.raw) } } } } });
            },
            
            renderTopProductsChart(transactions) {
                const ctx = document.getElementById('top-products-chart')?.getContext('2d');
                if (!ctx) return;
                const productCounts = {};
                transactions.forEach(t => t.items.forEach(item => productCounts[item.name] = (productCounts[item.name] || 0) + item.quantity));
                const sortedProducts = Object.entries(productCounts).sort(([,a],[,b]) => b-a).slice(0, 5);
                const labels = sortedProducts.map(p => p[0]);
                const data = sortedProducts.map(p => p[1]);
                if (this.state.topProductsChart) this.state.topProductsChart.destroy();
                this.state.topProductsChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ label: 'Jumlah Terjual', data, backgroundColor: ['rgba(79, 70, 229, 0.7)', 'rgba(59, 130, 246, 0.7)', 'rgba(16, 185, 129, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(239, 68, 68, 0.7)'], hoverOffset: 4 }] }, options: { responsive: true, plugins: { legend: { position: 'top' } } } });
            },
            
            renderTransactionHistory(transactions) {
                const tableBody = document.getElementById('transaction-history-table');
                if (!tableBody) return;
                tableBody.innerHTML = '';
                if (transactions.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-gray-500">Tidak ada riwayat transaksi.</td></tr>`;
                    return;
                }
                transactions.slice(0, 50).forEach(t => { // Show up to 50 recent transactions
                    tableBody.innerHTML += `
                        <tr class="border-b border-gray-200">
                            <td class="p-4 text-sm">${t.id}</td>
                            <td class="p-4 text-sm">${this.formatDate(t.date)}</td>
                            <td class="p-4 text-sm">${t.customerName || '-'}</td>
                            <td class="p-4 text-sm font-semibold">${this.formatCurrency(t.total)}</td>
                            <td class="p-4 text-sm">${t.paymentMethod}</td>
                            <td class="p-4 text-sm">
                                <button class="view-receipt-btn text-indigo-500 hover:underline" data-id="${t.id}">Lihat</button>
                            </td>
                        </tr>
                    `;
                });
            },

            // --- PRODUK PAGE ---
            async initProdukPage() {
                await this.renderProductManagementList();
            },
            
            async renderProductManagementList() {
                const listEl = document.getElementById('product-management-list');
                if (!listEl) return;
                const products = await this.getFromDB('products');
                listEl.innerHTML = '';
                if (products.length === 0) {
                    listEl.innerHTML = `<p class="p-4 text-center text-gray-500">Belum ada produk. Klik 'Tambah' untuk memulai.</p>`;
                    return;
                }
                products.forEach(p => {
                    const placeholderImg = `https://placehold.co/64x64/e2e8f0/4a5568?text=${encodeURIComponent(p.name.charAt(0))}`;
                    listEl.innerHTML += `
                        <div class="product-manage-item flex items-center p-4 border-b border-gray-200 last:border-b-0" data-id="${p.id}">
                            <img src="${p.image || placeholderImg}" onerror="this.onerror=null;this.src='${placeholderImg}';" class="w-12 h-12 rounded-lg object-cover mr-4">
                            <div class="flex-grow">
                                <p class="font-semibold">${p.name} <span class="text-xs text-gray-400 font-normal">(${this.formatProductId(p.id)})</span></p>
                                <p class="text-sm text-gray-500">${p.category} - ${this.formatCurrency(p.price)}</p>
                            </div>
                            <div class="space-x-2">
                                <button class="btn-edit-product text-blue-500 hover:text-blue-700 w-8 h-8 rounded-full hover:bg-gray-200 transition"><i class="fas fa-pencil-alt"></i></button>
                                <button class="btn-delete-product text-red-500 hover:text-red-700 w-8 h-8 rounded-full hover:bg-gray-200 transition"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                    `;
                });
            },
            
            async editProduct(id) {
                const product = await this.getFromDBById('products', id);
                if (product) this.openProductModal(product);
            },

            async deleteProduct(id) {
                await this.deleteFromDB('products', id);
                this.showToast('Produk berhasil dihapus');
                await this.renderProductManagementList();
                if(this.state.currentPage === 'kasir') {
                    await this.renderProducts();
                }
            },

            // --- PENGATURAN PAGE ---
            async initPengaturanPage() {
                // Load cafe info
                document.getElementById('cafe-name').value = await this.getSetting('cafeName') || '';
                document.getElementById('cafe-address').value = await this.getSetting('cafeAddress') || '';
                document.getElementById('cafe-phone').value = await this.getSetting('cafePhone') || '';
                
                // Load tax settings
                const taxEnabled = await this.getSetting('taxEnabled');
                const taxPercent = await this.getSetting('taxPercent') || 11;
                document.getElementById('tax-enabled-toggle').checked = taxEnabled;
                document.getElementById('tax-percent').value = taxPercent;
                document.getElementById('tax-percent-container').style.display = taxEnabled ? 'block' : 'none';

                await this.renderCategoryList();
                await this.renderCashierList();
            },
            
            async renderCategoryList() {
                const listEl = document.getElementById('category-list');
                if (!listEl) return;
                const categories = await this.getFromDB('categories');
                listEl.innerHTML = '';
                if (categories.length === 0) {
                    listEl.innerHTML = `<p class="text-center text-gray-500 text-sm">Belum ada kategori.</p>`;
                    return;
                }
                categories.forEach(c => {
                    listEl.innerHTML += `
                        <div class="category-item flex items-center justify-between p-2 bg-gray-50 rounded-lg" data-id="${c.id}">
                            <p class="font-medium text-sm">${c.name}</p>
                            <div class="space-x-1">
                                <button class="btn-edit-category text-blue-500 hover:text-blue-700 w-7 h-7 rounded-full hover:bg-gray-200 transition"><i class="fas fa-pencil-alt text-xs"></i></button>
                                <button class="btn-delete-category text-red-500 hover:text-red-700 w-7 h-7 rounded-full hover:bg-gray-200 transition"><i class="fas fa-trash-alt text-xs"></i></button>
                            </div>
                        </div>
                    `;
                });
            },

            async editCategory(id) {
                const category = await this.getFromDBById('categories', id);
                if (category) this.openCategoryModal(category);
            },

            async deleteCategory(id) {
                await this.deleteFromDB('categories', id);
                this.showToast('Kategori berhasil dihapus.');
                this.renderCategoryList();
                if (this.state.currentPage === 'kasir') this.renderCategoryFilters();
            },

            async renderCashierList() {
                const listEl = document.getElementById('cashier-list');
                if (!listEl) return;
                const cashiers = await this.getFromDB('cashiers');
                listEl.innerHTML = '';
                if (cashiers.length === 0) {
                    listEl.innerHTML = `<p class="text-center text-gray-500 text-sm">Belum ada kasir.</p>`;
                    return;
                }
                cashiers.forEach(c => {
                    listEl.innerHTML += `
                        <div class="cashier-item flex items-center justify-between p-2 bg-gray-50 rounded-lg" data-id="${c.id}">
                            <p class="font-medium text-sm">${c.name}</p>
                            <div class="space-x-1">
                                <button class="btn-edit-cashier text-blue-500 hover:text-blue-700 w-7 h-7 rounded-full hover:bg-gray-200 transition"><i class="fas fa-pencil-alt text-xs"></i></button>
                                <button class="btn-delete-cashier text-red-500 hover:text-red-700 w-7 h-7 rounded-full hover:bg-gray-200 transition"><i class="fas fa-trash-alt text-xs"></i></button>
                            </div>
                        </div>
                    `;
                });
            },

            async editCashier(id) {
                const cashier = await this.getFromDBById('cashiers', id);
                if (cashier) this.openCashierModal(cashier);
            },

            async deleteCashier(id) {
                await this.deleteFromDB('cashiers', id);
                this.showToast('Kasir berhasil dihapus.');
                this.renderCashierList();
            },

            // --- DATA MANAGEMENT ---
            async exportToExcel() {
                const transactions = await this.getFromDB('transactions');
                if (transactions.length === 0) {
                    this.showToast('Tidak ada data transaksi untuk diekspor.', true);
                    return;
                }
                const dataToExport = transactions.map(t => ({ 
                    'ID Transaksi': t.id, 
                    'Tanggal': this.formatDate(t.date), 
                    'Waktu': new Date(t.date).toLocaleTimeString('id-ID'), 
                    'Pelanggan': t.customerName || '-', 
                    'Items': t.items.map(i => `${i.name} (x${i.quantity})`).join(', '), 
                    'Subtotal': t.subtotal, 
                    'Pajak': t.tax, 
                    'Total': t.total, 
                    'Metode Pembayaran': t.paymentMethod 
                }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                worksheet['!cols'] = [ { wch: 20 }, { wch: 12 }, { wch: 10 }, { wch: 20 }, { wch: 50 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 20 } ];
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Laporan Penjualan');
                XLSX.writeFile(workbook, `Laporan_Penjualan_${new Date().toISOString().slice(0,10)}.xlsx`);
                this.showToast('Laporan berhasil diekspor!');
            },
            
            async backupData() {
                const backup = {};
                const objectStoreNames = Array.from(this.db.objectStoreNames);
                const promises = objectStoreNames.map(name => this.getFromDB(name).then(data => backup[name] = data));
                await Promise.all(promises);
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `kasir-pro-backup-${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                this.showToast('Backup data berhasil diunduh.');
            },

            importData(event) {
                const file = event.target.files[0];
                if (!file) return;
                this.openConfirmModal('Import Data?', 'Mengimpor akan MENGGANTI semua data saat ini. Lanjutkan?', () => {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            const objectStoreNames = Array.from(this.db.objectStoreNames);
                            const tx = this.db.transaction(objectStoreNames, 'readwrite');
                            tx.onerror = (err) => console.error("Import transaction error:", err);
                            
                            objectStoreNames.forEach(name => {
                                if (data[name]) {
                                    const store = tx.objectStore(name);
                                    store.clear();
                                    data[name].forEach(item => store.put(item));
                                }
                            });
                            tx.oncomplete = () => {
                                this.showToast('Data berhasil diimpor! Aplikasi akan dimuat ulang.');
                                setTimeout(() => window.location.reload(), 2000);
                            };
                        } catch (error) { this.showToast('File backup tidak valid.', true); console.error(error); }
                    };
                    reader.readAsText(file);
                });
                event.target.value = null; // Reset file input
            },

            async deleteAllData() {
                const objectStoreNames = Array.from(this.db.objectStoreNames);
                const tx = this.db.transaction(objectStoreNames, 'readwrite');
                objectStoreNames.forEach(name => tx.objectStore(name).clear());
                tx.oncomplete = () => {
                    this.showToast('Semua data berhasil dihapus! Aplikasi akan dimuat ulang.');
                    setTimeout(() => window.location.reload(), 2000);
                };
            },

            // --- MODALS & FORMS ---
            openModal(modalId) {
                this.elements.modalContainer.style.display = 'flex';
                this.elements.modalContainer.querySelectorAll('.modal-content').forEach(m => m.classList.add('hidden'));
                document.getElementById(modalId).classList.remove('hidden');
            },
            closeModal() { this.elements.modalContainer.style.display = 'none'; },
            
            async openProductModal(product = null) {
                this.openModal('product-modal');
                const form = document.getElementById('product-form');
                form.reset();
                document.getElementById('product-id').value = '';
                document.getElementById('product-image-base64').value = '';
                const imagePreview = document.getElementById('image-preview');
                imagePreview.classList.add('hidden');
                imagePreview.src = '';
                
                // Populate category dropdown
                const categorySelect = document.getElementById('product-category');
                categorySelect.innerHTML = '<option value="" disabled selected>Pilih Kategori...</option>';
                const categories = await this.getFromDB('categories');
                categories.forEach(cat => {
                    categorySelect.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
                });

                // Reset image source radio
                const urlRadio = form.querySelector('input[name="image-source"][value="url"]');
                urlRadio.checked = true;
                document.getElementById('image-url-container').classList.remove('hidden');
                document.getElementById('image-upload-container').classList.add('hidden');

                if (product) {
                    document.getElementById('product-modal-title').textContent = 'Edit Produk';
                    document.getElementById('product-id').value = product.id;
                    document.getElementById('product-name').value = product.name;
                    document.getElementById('product-price').value = product.price;
                    categorySelect.value = product.category;

                    if (product.image) {
                        if (product.image.startsWith('data:image')) {
                            form.querySelector('input[name="image-source"][value="upload"]').checked = true;
                            document.getElementById('image-url-container').classList.add('hidden');
                            document.getElementById('image-upload-container').classList.remove('hidden');
                            imagePreview.src = product.image;
                            imagePreview.classList.remove('hidden');
                            document.getElementById('product-image-base64').value = product.image;
                        } else {
                            urlRadio.checked = true;
                            document.getElementById('product-image-url').value = product.image;
                        }
                    }
                } else {
                    document.getElementById('product-modal-title').textContent = 'Tambah Produk Baru';
                }
            },

            async saveProductForm() {
                const form = document.getElementById('product-form');
                if (!form.checkValidity()) {
                    this.showToast('Harap isi semua kolom yang wajib.', true);
                    return;
                }
                const id = parseInt(document.getElementById('product-id').value);
                const imageSource = document.querySelector('input[name="image-source"]:checked').value;
                let imageUrl = '';
                if (imageSource === 'url') {
                    imageUrl = document.getElementById('product-image-url').value.trim();
                } else {
                    imageUrl = document.getElementById('product-image-base64').value;
                }
                const productData = { 
                    name: document.getElementById('product-name').value.trim(), 
                    price: parseInt(document.getElementById('product-price').value), 
                    category: document.getElementById('product-category').value, 
                    image: imageUrl 
                };
                if (id) productData.id = id;
                
                await this.saveToDB('products', productData);
                this.showToast(`Produk berhasil ${id ? 'diperbarui' : 'disimpan'}`);
                this.closeModal();
                if (this.state.currentPage === 'produk') this.renderProductManagementList();
                if (this.state.currentPage === 'kasir') {
                    this.renderProducts('all', document.getElementById('product-search').value);
                }
            },

            openCategoryModal(category = null) {
                this.openModal('category-modal');
                const form = document.getElementById('category-form');
                form.reset();
                document.getElementById('category-id').value = '';
                if (category) {
                    document.getElementById('category-modal-title').textContent = 'Edit Kategori';
                    document.getElementById('category-id').value = category.id;
                    document.getElementById('category-name').value = category.name;
                } else {
                    document.getElementById('category-modal-title').textContent = 'Tambah Kategori Baru';
                }
            },

            async saveCategoryForm() {
                const form = document.getElementById('category-form');
                if (!form.checkValidity()) {
                    this.showToast('Nama kategori tidak boleh kosong.', true);
                    return;
                }
                const id = parseInt(document.getElementById('category-id').value);
                const name = document.getElementById('category-name').value.trim();

                const categories = await this.getFromDB('categories');
                const isDuplicate = categories.some(cat => cat.name.toLowerCase() === name.toLowerCase() && cat.id !== id);
                if (isDuplicate) {
                    this.showToast('Nama kategori sudah ada.', true);
                    return;
                }

                const categoryData = { name };
                if (id) categoryData.id = id;

                await this.saveToDB('categories', categoryData);
                this.showToast(`Kategori berhasil ${id ? 'diperbarui' : 'disimpan'}.`);
                this.closeModal();
                this.renderCategoryList();
                if (this.state.currentPage === 'kasir') this.renderCategoryFilters();
            },

            openCashierModal(cashier = null) {
                this.openModal('cashier-modal');
                const form = document.getElementById('cashier-form');
                form.reset();
                document.getElementById('cashier-id').value = '';
                if (cashier) {
                    document.getElementById('cashier-modal-title').textContent = 'Edit Kasir';
                    document.getElementById('cashier-id').value = cashier.id;
                    document.getElementById('cashier-name').value = cashier.name;
                    document.getElementById('cashier-pin').value = cashier.pin;
                } else {
                    document.getElementById('cashier-modal-title').textContent = 'Tambah Kasir Baru';
                }
            },

            async saveCashierForm() {
                const form = document.getElementById('cashier-form');
                if (!form.checkValidity()) {
                    this.showToast('Harap isi semua kolom.', true);
                    return;
                }
                const id = parseInt(document.getElementById('cashier-id').value);
                const cashierData = { 
                    name: document.getElementById('cashier-name').value.trim(), 
                    pin: document.getElementById('cashier-pin').value 
                };
                if (id) cashierData.id = id;
                
                await this.saveToDB('cashiers', cashierData);
                this.showToast(`Kasir berhasil ${id ? 'diperbarui' : 'disimpan'}.`);
                this.closeModal();
                this.renderCashierList();
            },

            openPinModal() {
                this.openModal('pin-modal');
                document.getElementById('pin-form').reset();
            },

            async savePinForm() {
                const form = document.getElementById('pin-form');
                if (!form.checkValidity()) {
                    this.showToast('Harap isi semua kolom.', true);
                    return;
                }
                const currentAdminPin = document.getElementById('current-admin-pin').value;
                const newPin = document.getElementById('new-pin').value;
                if (newPin.length !== 4 || !/^\d{4}$/.test(newPin)) {
                    this.showToast('PIN baru harus 4 angka.', true); return;
                }
                const storedAdminPin = await this.getSetting('adminPin') || '0000';
                if (currentAdminPin !== storedAdminPin) {
                    this.showToast('PIN Admin saat ini salah.', true); return;
                }
                await this.saveSetting('adminPin', newPin);
                this.showToast('PIN Admin berhasil diubah.');
                this.closeModal();
            },

            async openPaymentModal() {
                if (this.state.cart.length === 0) {
                    this.showToast('Keranjang kosong!', true);
                    return;
                }
                this.openModal('payment-modal');
                const { total } = await this.calculateCartTotal();
                document.getElementById('payment-total').textContent = this.formatCurrency(total);
                document.getElementById('customer-name').value = '';
                document.getElementById('cash-received').value = '';
                document.getElementById('cash-change').textContent = this.formatCurrency(0);
                document.getElementById('payment-method').value = 'Tunai';
                document.getElementById('cash-payment-section').style.display = 'block';
            },

            async completePayment() {
                const { subtotal, tax, total } = await this.calculateCartTotal();
                const taxEnabled = await this.getSetting('taxEnabled');
                const taxPercentValue = await this.getSetting('taxPercent') || 0;

                const transactionData = { 
                    id: `TRX-${Date.now()}`, 
                    date: new Date().getTime(), 
                    items: this.state.cart, 
                    subtotal, 
                    tax, 
                    taxPercent: taxEnabled ? taxPercentValue : 0, 
                    total, 
                    paymentMethod: document.getElementById('payment-method').value, 
                    customerName: document.getElementById('customer-name').value.trim() 
                };
                
                await this.saveToDB('transactions', transactionData);
                this.showToast('Transaksi berhasil!');
                this.state.cart = [];
                this.closeModal();
                this.updateCartView();
                this.showReceipt(transactionData.id);
            },

            async generateReceiptHtml(transactionId) {
                const t = await this.getFromDBById('transactions', transactionId);
                if (!t) return null;

                const cafeName = await this.getSetting('cafeName') || 'Kafe Anda';
                const cafeAddress = await this.getSetting('cafeAddress') || '';
                const cafePhone = await this.getSetting('cafePhone') || '';
                const cashierName = this.state.currentUserRole === 'admin' ? 'Admin' : this.state.currentCashierName;
                
                let itemsHtml = t.items.map(item => 
                    `<div class="flex justify-between"><div><p>${item.name}</p><p class="text-sm text-gray-500">${item.quantity} x ${this.formatCurrency(item.price)}</p></div><p>${this.formatCurrency(item.quantity * item.price)}</p></div>`
                ).join('');

                const taxLine = t.tax > 0 ? `<div class="flex justify-between"><p>Pajak (${t.taxPercent}%)</p><p>${this.formatCurrency(t.tax)}</p></div>` : '';
                
                return `
                    <div class="text-center mb-4"><h3 class="text-xl font-bold">${cafeName}</h3><p class="text-sm">${cafeAddress}</p><p class="text-sm">${cafePhone}</p></div>
                    <div class="text-sm space-y-1 mb-4 border-b pb-2"><p>ID: ${t.id}</p><p>Tanggal: ${new Date(t.date).toLocaleString('id-ID')}</p><p>Kasir: ${cashierName}</p>${t.customerName ? `<p>Pelanggan: ${t.customerName}</p>` : ''}</div>
                    <div class="space-y-2 text-sm mb-4 border-b pb-2">${itemsHtml}</div>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between"><p>Subtotal</p><p>${this.formatCurrency(t.subtotal)}</p></div>
                        ${taxLine}
                        <div class="flex justify-between font-bold text-base"><p>Total</p><p>${this.formatCurrency(t.total)}</p></div>
                        <div class="flex justify-between"><p>Metode Bayar</p><p>${t.paymentMethod}</p></div>
                    </div>
                    <div class="text-center mt-6 text-sm"><p>--- Terima Kasih ---</p></div>
                `;
            },

            async showReceipt(transactionId) {
                this.state.currentTransactionIdForModal = transactionId;
                const receiptHtml = await this.generateReceiptHtml(transactionId);
                if (!receiptHtml) {
                    this.showToast('Gagal memuat data transaksi.', true);
                    return;
                }
                document.getElementById('receipt-content').innerHTML = receiptHtml;
                this.openModal('receipt-modal');
            },

            printReceipt() {
                const receiptHtml = document.getElementById('receipt-content').innerHTML;
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`<html><head><title>Struk</title><style>body { font-family: monospace; font-size: 12px; max-width: 300px; margin: 0 auto; } .flex { display: flex; } .justify-between { justify-content: space-between; } .text-center { text-align: center; } .font-bold { font-weight: bold; } .mb-4 { margin-bottom: 1rem; } .pb-2 { padding-bottom: 0.5rem; } .border-b { border-bottom: 1px dashed #ccc; } .mt-6 { margin-top: 1.5rem; } .text-xl { font-size: 1.25rem; } .text-sm { font-size: 0.875rem; } .space-y-1 > * + * { margin-top: 0.25rem; } .space-y-2 > * + * { margin-top: 0.5rem; }</style></head><body>${receiptHtml}</body></html>`);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            },
            
            async shareReceiptAsImage() {
                const transactionId = this.state.currentTransactionIdForModal;
                if (!transactionId) return;

                if (typeof html2canvas === 'undefined') {
                    this.showToast('Pustaka gambar (html2canvas) tidak termuat.', true);
                    return;
                }
                
                this.showToast('Membuat gambar nota...');
                
                const receiptHtml = await this.generateReceiptHtml(transactionId);
                if (!receiptHtml) {
                    this.showToast('Gagal membuat HTML nota.', true);
                    return;
                }

                const receiptContainer = document.createElement('div');
                receiptContainer.style.position = 'fixed';
                receiptContainer.style.left = '-9999px';
                receiptContainer.style.top = '0px';
                receiptContainer.style.width = '320px';
                receiptContainer.style.padding = '16px';
                receiptContainer.style.backgroundColor = 'white';
                receiptContainer.style.fontFamily = 'Inter, sans-serif';
                receiptContainer.innerHTML = `<style>.flex{display:flex}.justify-between{justify-content:space-between}.text-center{text-align:center}.font-bold{font-weight:700}.mb-4{margin-bottom:1rem}.pb-2{padding-bottom:.5rem}.border-b{border-bottom:1px dashed #ccc}.mt-6{margin-top:1.5rem}.text-xl{font-size:1.25rem}.text-lg{font-size:1.125rem}.text-base{font-size:1rem}.text-sm{font-size:.875rem}.text-gray-500{color:#6b7280}.space-y-1>*:not([hidden])~*:not([hidden]){margin-top:.25rem}.space-y-2>*:not([hidden])~*:not([hidden]){margin-top:.5rem}</style>` + receiptHtml;
                document.body.appendChild(receiptContainer);

                try {
                    const canvas = await html2canvas(receiptContainer, { scale: 2.5, useCORS: true });
                    canvas.toBlob(async (blob) => {
                        if (!blob) throw new Error('Gagal membuat blob dari canvas.');
                        
                        const file = new File([blob], `nota-${transactionId}.png`, { type: 'image/png' });
                        const shareData = {
                            files: [file],
                            title: `Nota Transaksi ${transactionId}`,
                            text: `Berikut adalah nota untuk transaksi ${transactionId}.`,
                        };

                        if (navigator.canShare && navigator.canShare(shareData)) {
                            await navigator.share(shareData);
                            this.showToast('Nota berhasil dibagikan!', false);
                        } else {
                            this.showToast('Browser tidak mendukung fitur berbagi. Unduh gambar.', true);
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(blob);
                            link.download = `nota-${transactionId}.png`;
                            link.click();
                            URL.revokeObjectURL(link.href);
                        }
                    }, 'image/png');
                } catch (err) {
                    console.error('Error generating image:', err);
                    this.showToast('Gagal membuat gambar nota.', true);
                } finally {
                    document.body.removeChild(receiptContainer);
                }
            },

            openConfirmModal(title, text, onConfirm) {
                this.openModal('confirm-modal');
                document.getElementById('confirm-modal-title').textContent = title;
                document.getElementById('confirm-modal-text').textContent = text;
                const confirmBtn = document.getElementById('confirm-modal-button');
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                newConfirmBtn.onclick = () => { onConfirm(); this.closeModal(); };
            },

            handleImageUpload(file) {
                if (!file || !file.type.startsWith('image/')) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('product-image-base64').value = e.target.result;
                    const preview = document.getElementById('image-preview');
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            },

            async calculateChange() {
                const { total } = await this.calculateCartTotal();
                const cashReceived = parseFloat(document.getElementById('cash-received').value) || 0;
                const change = cashReceived > total ? cashReceived - total : 0;
                document.getElementById('cash-change').textContent = this.formatCurrency(change);
            },

            async calculateCartTotal() {
                const subtotal = this.state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const taxEnabled = await this.getSetting('taxEnabled');
                const taxPercent = await this.getSetting('taxPercent') || 0;
                const taxRate = taxEnabled ? parseFloat(taxPercent) / 100 : 0;
                const tax = subtotal * taxRate;
                const total = subtotal + tax;
                return { subtotal, tax, total };
            },

            // --- PIN LOCK SCREEN (Existing Logic) ---
            updatePinDots() {
                const dots = this.elements.pinDots.children;
                for (let i = 0; i < dots.length; i++) {
                    dots[i].classList.toggle('bg-indigo-500', i < this.state.pinInput.length);
                    dots[i].classList.toggle('border-gray-400', i >= this.state.pinInput.length);
                }
            },
            
            handlePinKey(key) {
                if (key === 'backspace') {
                    this.state.pinInput = this.state.pinInput.slice(0, -1);
                } else if (this.state.pinInput.length < 4) {
                    this.state.pinInput += key;
                }
                this.updatePinDots();
                if (this.state.pinInput.length === 4) this.checkPin();
            },

            async checkPin() {
                const adminPin = await this.getSetting('adminPin') || '0000';
                if (this.state.pinInput === adminPin) {
                    this.state.currentUserRole = 'admin';
                    this.state.currentCashierName = 'Admin';
                } else {
                    const cashiers = await this.getFromDB('cashiers');
                    const matchedCashier = cashiers.find(c => c.pin === this.state.pinInput);
                    if (matchedCashier) {
                        this.state.currentUserRole = 'cashier';
                        this.state.currentCashierName = matchedCashier.name;
                    }
                }

                if (this.state.currentUserRole) {
                    this.elements.lockScreen.classList.add('hidden');
                    this.elements.appContainer.classList.remove('hidden');
                    this.updateUIAccess();
                    this.navigateTo('kasir');
                } else {
                    this.elements.pinDots.classList.add('shake');
                    this.showToast('PIN Salah', true);
                    setTimeout(() => {
                        this.elements.pinDots.classList.remove('shake');
                        this.state.pinInput = '';
                        this.updatePinDots();
                    }, 500);
                }
            },
            
            updateUIAccess() {
                const isAdmin = this.state.currentUserRole === 'admin';
                document.querySelector('[data-page="laporan"]').style.display = isAdmin ? 'flex' : 'none';
                document.querySelector('[data-page="produk"]').style.display = isAdmin ? 'flex' : 'none';
                document.querySelector('[data-page="pengaturan"]').style.display = isAdmin ? 'flex' : 'none';
            },

            // --- UTILITIES & DB HELPERS ---
            formatCurrency: (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount),
            formatDate: (date) => new Date(date).toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' }),
            formatProductId: (id) => `P${String(id).padStart(3, '0')}`,

            showToast(message, isError = false) {
                this.elements.toastMessage.textContent = message;
                this.elements.toast.classList.toggle('bg-red-500', isError);
                this.elements.toast.classList.toggle('bg-green-500', !isError);
                this.elements.toast.classList.remove('translate-x-[120%]');
                setTimeout(() => {
                    this.elements.toast.classList.add('translate-x-[120%]');
                }, 3000);
            },

            getFromDB(storeName) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readonly');
                    transaction.onerror = (e) => reject(e);
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                });
            },

            getFromDBById(storeName, id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readonly');
                    transaction.onerror = (e) => reject(e);
                    const store = transaction.objectStore(storeName);
                    const request = store.get(id);
                    request.onsuccess = () => resolve(request.result);
                });
            },

            saveToDB(storeName, data) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readwrite');
                    transaction.onerror = (e) => reject(e);
                    transaction.oncomplete = () => resolve();
                    transaction.objectStore(storeName).put(data);
                });
            },

            deleteFromDB(storeName, id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, 'readwrite');
                    transaction.onerror = (e) => reject(e);
                    transaction.oncomplete = () => resolve();
                    transaction.objectStore(storeName).delete(id);
                });
            },

            saveSetting(key, value) { return this.saveToDB('settings', { key, value }); },
            
            async getSetting(key) {
                const result = await this.getFromDBById('settings', key);
                return result ? result.value : null;
            }
        };

        App.init();
    });
    </script>
    <script>
    // URL redirect target
        const redirectUrl = "https://lynk.id/muslimtechpreneur";

        // 1. Disable klik kanan dan drag image
        document.addEventListener("contextmenu", e => e.preventDefault());
        document.addEventListener("dragstart", e => e.preventDefault());
        document.addEventListener("mousedown", e => {
          if (e.button === 2 || e.button === 1) e.preventDefault();
        });

        // 2. Disable shortcut keyboard untuk Inspect & Save Source
        document.addEventListener("keydown", function(e) {
          if (
            e.key === "F12" ||
            (e.ctrlKey && e.shiftKey && ["I", "J", "C", "K"].includes(e.key.toUpperCase())) ||
            (e.ctrlKey && ["U", "S"].includes(e.key.toUpperCase()))
          ) {
            e.preventDefault();
            window.location.href = redirectUrl;
          }
        });

        // 3. Deteksi DevTools via console.log trick
        (function detectConsoleOpen() {
          const element = new Image();
          Object.defineProperty(element, "id", {
            get: function () {
              window.location.replace(redirectUrl);
            }
          });
          setInterval(() => {
            console.log(element);
          }, 1000);
        })();

        // 4. (Opsional) Cegah download gambar via klik kanan Save As
        document.addEventListener("DOMContentLoaded", () => {
          document.querySelectorAll("img").forEach(img => {
            img.setAttribute("draggable", "false");
            img.oncontextmenu = e => e.preventDefault();
          });
        });

// Daftarkan service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js')
    .then(reg => console.log('SW berhasil:', reg))
    .catch(err => console.error('SW gagal:', err));
}</script>
    
</body>
</html>
